name: Inbox Auto-Processor

on:
  push:
    branches: [ "main" ]
    paths:
      - "inbox/**"
      - "!inbox/processed/**"
      - "!inbox/README.md"
  workflow_dispatch:  # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é

jobs:
  process-inbox:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Check for unprocessed files
        id: check_files
        run: |
          # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —Ñ–∞–π–ª—ã –≤ inbox (–∏—Å–∫–ª—é—á–∞—è README.md –∏ processed/)
          file_count=$(find inbox -type f -name "*.md" ! -path "*/processed/*" ! -name "README.md" | wc -l)
          echo "file_count=$file_count" >> $GITHUB_OUTPUT
          echo "Found $file_count unprocessed files in inbox"
      
      - name: Process inbox files
        if: steps.check_files.outputs.file_count > 0
        run: |
          python scripts/process_inbox.py
      
      - name: Configure Git
        if: steps.check_files.outputs.file_count > 0
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Create Pull Request
        if: steps.check_files.outputs.file_count > 0
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Auto-process inbox files"
          branch: auto-process-inbox
          delete-branch: true
          title: "ü§ñ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤ –∏–∑ inbox"
          body: |
            ## –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ inbox
            
            –≠—Ç–æ—Ç PR –±—ã–ª —Å–æ–∑–¥–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ GitHub Actions –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–æ–≤ –∏–∑ `inbox/`.
            
            ### –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ:
            - –û–±—Ä–∞–±–æ—Ç–∞–Ω—ã —Ñ–∞–π–ª—ã –∏–∑ `inbox/`
            - –°–æ–∑–¥–∞–Ω—ã —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å—Ç–∞—Ç—å–∏ –≤ `kb/ru/`
            - –û–±–Ω–æ–≤–ª–µ–Ω—ã –∏–Ω–¥–µ–∫—Å—ã –∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
            - –§–∞–π–ª—ã –ø–µ—Ä–µ–º–µ—â–µ–Ω—ã –≤ `inbox/processed/`
            
            –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–¥ —Å–ª–∏—è–Ω–∏–µ–º.
          labels: |
            automated
            inbox-processing
